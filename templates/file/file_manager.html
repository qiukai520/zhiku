
{% extends "content_table_layout.html" %}
{% load file_tags %}
{% block css %}
     <link href="/static/css/font-awesome.min.css" rel="stylesheet">
    <link href="/static/css/plugins/treeview/bootstrap-treeview.css" rel="stylesheet">
    <link href="/static/css/animate.css" rel="stylesheet">
{#     <link href="/static/css/custom/file_upload/component.css" rel="stylesheet">#}
{#     <link href="/static/css/custom/file_upload/default.css" rel="stylesheet">#}
     <link href="/static/css/custom/file_upload/normalize.css" rel="stylesheet">
      <link rel="stylesheet" href="/static/plugins/webuploader/css/webuploader.css">
     <link href="/static/css/plugins/iCheck/custom.css" rel="stylesheet">
    <style>
     #toolbar >.btn{
          margin: 2px;
      }
      #picker {
    display: inline-block;
    line-height: 1.428571429;
    vertical-align: middle;
    margin: 0 12px 0 0;
}
      #picker div:nth-child(2){width:100%!important;height:100%!important;}

    .close {
    float: right;
    font-size: 30px;
    font-weight: 700;
    line-height: 1;
    color: #000;
    text-shadow: 0 1px 0 #fff;
    filter: alpha(opacity=20);
    opacity: 0.5;
}


    </style>
{%endblock %}
{% block content %}

 <div class="wrapper wrapper-content">
        <div class="row">
            <div class="col-sm-3">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <div class="file-manager">
                              <a  style="float:right" class="btn btn-info btn-add" title="刷新" href="javascript:window.location.reload()"> <span class='glyphicon glyphicon-refresh'/></a>

                            <h5>显示：</h5>
                            <a href="#" class="file-control active">所有</a>
                            <a href="#" class="file-control">文档</a>
                            <a href="#" class="file-control">图片</a>
                            <div class="hr-line-dashed"></div>
                            <button class="btn btn-primary btn-block" onclick="fileUpload()">上传文件</button>
                            <div class="hr-line-dashed"></div>
                            <h5>文件夹</h5>
                            <ul class="folder-list" style="padding: 0">
                                <li><a href="file_manager.html"><i class="fa fa-folder"></i> 技术部</a>
                                </li>
                                <li><a href="file_manager.html"><i class="fa fa-folder"></i>销售部</a>
                                </li>
                                <li><a href="file_manager.html"><i class="fa fa-folder"></i>客户部</a>
                                </li>
                                <li><a href="file_manager.html"><i class="fa fa-folder"></i>其他</a>
                                </li>
                                <li><a href="file_manager.html"><i class="fa fa-folder"></i> 公共</a>
                                </li>

                            </ul>
                            <h5 class="tag-title">标签</h5>
                            <ul class="tag-list" style="padding: 0">
                                {% fetch_tags as tag_list %}
                                {% for item in tag_list %}
                                    <li><a href="file_manager.html">{{ item.name }}</a>
                                    </li>
                                {% endfor %}

                                 <li><a onclick="addTag()">+</a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-9 animated fadeInRight">
                <div class="row">
                    <div class="col-sm-12">
                        {% for item in query_set %}
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="icon">
                                        <i class="fa fa-file"></i>
                                    </div>
                                    <div class="file-name">
                                        item.name
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="image">
                                        <img alt="image" class="img-responsive" src="img/p1.jpg">
                                    </div>
                                    <div class="file-name">
                                        Italy street.jpg
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>

                            </div>
                        </div>
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="image">
                                        <img alt="image" class="img-responsive" src="img/p2.jpg">
                                    </div>
                                    <div class="file-name">
                                        My feel.png
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="icon">
                                        <i class="fa fa-music"></i>
                                    </div>
                                    <div class="file-name">
                                        Michal Jackson.mp3
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="image">
                                        <img alt="image" class="img-responsive" src="img/p3.jpg">
                                    </div>
                                    <div class="file-name">
                                        Document_2014.doc
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="icon">
                                        <i class="img-responsive fa fa-film"></i>
                                    </div>
                                    <div class="file-name">
                                        Monica's birthday.mpg4
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="file-box">
                            <a href="#">
                                <div class="file">
                                    <span class="corner"></span>

                                    <div class="icon">
                                        <i class="fa fa-bar-chart-o"></i>
                                    </div>
                                    <div class="file-name">
                                        Annual report 2014.xls
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="icon">
                                        <i class="fa fa-file"></i>
                                    </div>
                                    <div class="file-name">
                                        Document_2014.doc
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>
                            </div>

                        </div>
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="image">
                                        <img alt="image" class="img-responsive" src="">
                                    </div>
                                    <div class="file-name">
                                        Italy street.jpg
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>

                            </div>
                        </div>
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="image">
                                        <img alt="image" class="img-responsive" src="">
                                    </div>
                                    <div class="file-name">
                                        My feel.png
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="icon">
                                        <i class="fa fa-music"></i>
                                    </div>
                                    <div class="file-name">
                                        Michal Jackson.mp3
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="file-box">
                            <div class="file">
                                <a href="#">
                                    <span class="corner"></span>

                                    <div class="image">
                                        <img alt="image" class="img-responsive" src="">
                                    </div>
                                    <div class="file-name">
                                        Document_2014.doc
                                        <br/>
                                        <small>添加时间：2014-10-13</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
          <!-- Modal -->
  <div class="modal fade" id="upload_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document" style="margin-left: 20px ">
     <div id="uploader" class="container">
        <!--用来存放文件信息-->
        <div id="thelist" class="row">
            <div class="panel panel-primary">
                <div class="panel-heading"><h3>文件上传
        <button type="button" class="close" data-dismiss="modal" onclick="clearUploader()" aria-label="Close"><span aria-hidden="true">&times;</span></button>
</h3>

                </div>
                <table class="table table-striped table-bordered" id="uploadTable">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>文件名称</th>
                            <th>文件大小</th>
                            <th>上传状态</th>
                            <th>上传进度</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="panel-footer">
                    <div class="hr-line-dashed"></div>
                  <div class="form-group row">
                    <label class="col-xs-2 col-sm-1  control-label" style="text-align: left">标签</label>
                        <div class="col-sm-10">
                            {% for item in tag_list %}
                            <label class="checkbox-inline i-checks">
                                <div class="icheckbox_square-green" style="position: relative;">
                                    <input type="checkbox" name="tags" value="{{ item.nid }}" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins>
                                </div>{{ item.name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    <br>
                  <div class="form-group row">
                      <label for="classify"  class="col-xs-2 col-sm-1  control-label" style="text-align: left;">类型</label>
                        <div id="classify" class="col-sm-10">
                            <div class="radio checkbox-inline i-checks">
                                <label class="">
                                    <div class="iradio_square-green" style="position: relative;"><input type="radio" value="1" name="classify" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins></div> <i></i> 图片</label>
                            </div>
                            <div class="radio checkbox-inline i-checks">
                                <label class="">
                                    <div class="iradio_square-green " style="position: relative;"><input type="radio" checked="checked" value="0" name="classify" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins></div> <i></i> 文件</label>
                            </div>
                        </div>
                      <div class="clearfix"></div>
                    </div>

                    <div id="picker" >选择文件</div>
                    <button id="btn" style="padding:8px 15px;margin-top:-5px" class="btn btn-default">开始上传</button>
                </div>

            </div>
        </div>
    </div>
  </div>
</div>

        <!-- tag-->
<div class="modal fade" id="tag_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
        <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h2 class="modal-title" id="myModalLabel">添加标签</h2>
      </div>
      <div class="modal-body" style="text-align: center;font-size: 20px;">
        <div class="row form-horizontal" style="position: relative;margin-top: 30px">
            <div class="col-xs-12">
                <div class="form-group">
                      <div class="col-xs-12 ">
                          <input name="tag_name"  class="form-control"  id="tag_name" placeholder="标签名">
                      </div>
                </div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="button" id="tag_ensure"  class="btn btn-primary">确定</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}
{% block js%}
    <script src="/static/js/plugins/iCheck/icheck.min.js"></script>
    <script src="/static/js/jquery.cookie.js"></script>
    <script type="text/javascript" src="/static/js/custom/common.js"></script>
    <script type="text/javascript" src="/static/js/custom/ajax.csrf.js"></script>
    <script type="text/javascript" src="/static/plugins/webuploader/js/webuploader.js"></script>
{#        <script src="/static/js/plugins/treeview/bootstrap-treeview.js"></script>#}
            <script src="/static/js/hashmap.js"></script>

 <script type="text/javascript">
        var BASE_URL = '/static/plugins/webuploader/index.html';
    </script>
    <script>
        //iCheck
        $(document).ready(function(){$(".i-checks").iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green",})});


    //预防跨站请求伪造
  var csrftoken = $.cookie('csrftoken');
        function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
        });


           /*
    自执行函数

    */
           function addTag() {
            $("#tag_modal").modal("show");//显示标签模态框
               $("#tag_ensure").click(function () {
                        console.log("llal")
                        var name = $("#tag_name").val();
                        console.log(name)
                        var data={"tag_name":name};
                        $.ajax({
                                url: '{% url "add_file_tag"%}',
                                type: "post",
                                data:  data,
                            dataType: "json",
                            success: function (arg) {
                                if (arg.status) {
                                      window.location.reload()
                                } else {
                                    layer.msg("添加失败")
                                }
                            }
                        })
                               }
               )
        }

        function fileUpload(){
            $("#upload_modal").modal("show");//显示上传模态框
        }


        //webloader 上传文件
        var fileMd5;
        var fileSuffix;
        var $list=$("#thelist table>tbody");
        var state = 'pending';//初始按钮状态
        var $btn=$("#btn");
        var count=0;
        var map=new HashMap();
        //监听分块上传过程中的三个时间点
        WebUploader.Uploader.register({
            "before-send-file" : "beforeSendFile",
            "before-send" : "beforeSend",
            "after-send-file" : "afterSendFile",
        }, {
            //时间点1：所有分块进行上传之前调用此函数
            beforeSendFile : function(file) {
                var deferred = WebUploader.Deferred();
                //1、计算文件的唯一标记，用于断点续传
                (new WebUploader.Uploader()).md5File(file, 0, 10 * 1024 * 1024)
                        .progress(function(percentage) {
                            $('#' + file.id).find("td.state").text("正在读取文件信息...");
                        }).then(function(val) {
                            fileMd5 = val;
                            $('#' + file.id).find("td.state").text("成功获取文件信息...");
                            //获取文件信息后进入下一步
                            deferred.resolve();
                        });
                return deferred.promise();
            },
            //时间点2：如果有分块上传，则每个分块上传之前调用此函数
            beforeSend : function(block) {
                var deferred = WebUploader.Deferred();
                $.ajax({
                    type : "POST",
                    url : "{% url "check_chunk" %}",
                    data : {
                        //文件唯一标记
                        fileMd5 : fileMd5,
                        //当前分块下标
                        chunk : block.chunk,
                        //当前分块大小
                        chunkSize : block.end - block.start
                    },
                    dataType : "json",
                    success : function(response) {
                        if (response.ifExist) {
                            //分块存在，跳过
                            deferred.reject();
                        } else {
                            //分块不存在或不完整，重新发送该分块内容
                            deferred.resolve();
                        }
                    }
                });
                this.owner.options.formData.fileMd5 = fileMd5;
                deferred.resolve();
                return deferred.promise();
            },
            //时间点3：所有分块上传成功后调用此函数
            afterSendFile : function(file) {
                //如果分块上传成功，则通知后台合并分块
                var file_size=file.size;
                var classify= $('input[name="classify"]:checked').val();
                var checkBoxArr = [];
                $('input[name="tags"]:checked').each(function() {
	                checkBoxArr.push($(this).val());});
                console.log("checkout",checkBoxArr)
                checkBoxArr=checkBoxArr.join("|")
                $.ajax({
                    type : "POST",
                    url : "{% url "merge_chunks" %}",
                    data : {
                        fileMd5 : fileMd5,
                        fileSuffix:fileSuffix,
                        fileName:fileName,
                        tags:checkBoxArr,
                        fileSize:file_size,
                        classify:classify,
                    },
                    success : function(response) {
                        if (response.upload) {
                             alert("上传成功");
                        //返回路径

                        }

                    }
                });
            }
        });
        var uploader = WebUploader.create({
                    // swf文件路径
                    {#swf : 'https://cdnjs.cloudflare.com/ajax/libs/webuploader/0.1.1/Uploader.swf',#}
                    swf:BASE_URL + "/Uploader.swf",  // swf文件所处路径
                    // 文件接收服务端。
                    server : "file_uploader.html",
                    // 选择文件的按钮。可选。
                    // 内部根据当前运行是创建，可能是input元素，也可能是flash.
                    pick : {
                        id : '#picker',//这个id是你要点击上传文件的id
                        multiple : true
                    },
                    // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
                    resize : true,
                    auto : false,
                    //开启分片上传
                    chunked : true,
                    chunkSize : 10 * 1024 * 1024,
                    accept : {
                        extensions : "txt,jpg,jpeg,bmp,png,zip,rar,war,pdf,cebx,doc,docx,ppt,pptx,xls,xlsx,iso",
                        mimeTypes : '.txt,.jpg,.jpeg,.bmp,.png,.zip,.rar,.war,.pdf,.cebx,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.iso'
                    },
                    headers: {
                    "X-CSRFToken": $.cookie('csrftoken')
        },
                });
        // 当有文件被添加进队列的时候
        uploader.on('fileQueued', function(file) {
            //保存文件扩展名
            fileSuffix=file.ext;
            fileName=file.source['name'];
            var fileSize=file.size;
            var fileSizeStr="";
            /* if(fileSize/1024<1024){
                fileSize=fileSize/1024;
                fileSizeStr=fileSize.toFixed(2)+"KB";
            }else if(fileSize/1024/1024<1024){
                fileSize=fileSize/1024/1024;
                fileSizeStr=fileSize.toFixed(2)+"MB";
            }else if(fileSize/1024/1024/1024<1024){
                fileSize=fileSize/1024/1024/1024;
                fileSizeStr=fileSize.toFixed(2)+"GB";
            }else{
                fileSize=fileSize/1024/1024/1024/1024;
                fileSizeStr=fileSize.toFixed(2)+"T";
            } */
            fileSizeStr=WebUploader.Base.formatSize(fileSize);
            count++;
            $list.append(
                    '<tr id="' + file.id + '" class="item" flag=0>'+
                    '<td class="index">' + count + '</td>'+
                    '<td class="info">' + file.name + '</td>'+
                    '<td class="size">' + fileSizeStr + '</td>'+
                    '<td class="state">等待上传...</td>'+
                    '<td class="percentage"></td>'+
                    '<td class="operate"><button name="upload" class="btn btn-warning">开始</button><button name="delete" class="btn btn-error">删除</button></td></tr>');
            map.put(file.id+"",file);
        });
        // 文件上传过程中创建进度条实时显示。
        uploader.on('uploadProgress', function(file, percentage) {
            $('#' + file.id).find('td.percentage').text(
                    '上传中 ' + Math.round(percentage * 100) + '%');
        });
        uploader.on('uploadSuccess', function(file) {
            $('#' + file.id).find('td.state').text('已上传');
        });
        uploader.on('uploadError', function(file) {
            $('#' + file.id).find('td.state').text('上传出错');
        });
        uploader.on('uploadComplete', function(file) {
            uploader.removeFile(file);
        });
        uploader.on('all', function(type) {
            if (type === 'startUpload') {
                state = 'uploading';
            } else if (type === 'stopUpload') {
                state = 'paused';
            } else if (type === 'uploadFinished') {
                state = 'done';
            }
            if (state === 'uploading') {
                $btn.text('暂停上传');
            } else {
                $btn.text('开始上传');
            }
        });
        $btn.on('click', function(){
            if (state === 'uploading'){
                uploader.stop(true);
            } else {
                uploader.upload();
            }
        });
        $("body").on("click","#uploadTable button[name='upload']",function(){
            flag=$(this).parents("tr.item").attr("flag")^1;
            $(this).parents("tr.item").attr("flag",flag);
            var id=$(this).parents("tr.item").attr("id");
            if(flag==1){
                $(this).text("暂停");
                uploader.upload(uploader.getFile(id,true));
            }else{
                $(this).text("开始");
                //uploader.stop(true);
                uploader.stop(uploader.getFile(id,true));
                //uploader.skipFile(file);
                //uploader.removeFile(file);
                //uploader.getFile(id,true);
            }
        });
        $("body").on("click","#uploadTable button[name='delete']",function(){
            var id=$(this).parents("tr.item").attr("id");
            $(this).parents("tr.item").remove();
            uploader.removeFile(uploader.getFile(id,true));
            map.remove(id);

        });

        function clearUploader() {
            console.log("clear")
        }


    </script>
{% endblock %}


