{% extends "content_edit_layout.html" %}
{% load  admin_tags %}
{% block css%}
    <style>
    #top > span{
        margin-right: 60px;
    }
      .form-horizontal .control-label {
            padding-top: 7px;
            margin-bottom: 0;
            text-align: right;
        }
{#    .minus {#}
{#       margin-left: 0px !important;#}
{#       color: red;#}
{#       position: absolute;#}
{#       top: 10px;#}
{#       left: -85px;#}
{##}
{#}#}
{#    .plus{#}
{#        position: absolute;#}
{#        top: 10px;#}
{#        left: -85px;#}
{#        color: blue#}
{#    }#}
    label{
        font-weight: bold;
    }
    .glyphicon-ok{
        border: 1px solid;
        padding: 1px;
        background-color: #9F9F9F;
        border-radius: 50%;
        color:white;
        position: absolute;
        top:28px;
        right: 38px

    }
{#    .btn-primary:hover {#}
{#    background-color:black !important;#}
{#}#}
{#    .btn-danger:hover{#}
{#            background-color: orangered !important;#}
{#          }#}
{#    .btn{#}
{#           border: none;#}
{#       }#}
{#    .btn-info:hover{#}
{#              background-color: #2271f0 !important;#}
{#        }#}
    .row > [class*="col-"] {
    margin-bottom: 0px;
}
    .flat-blue a {
    color: #075dec;
}
     #content-main{
      overflow :auto
     }

    .progress{position: relative; width:220px ;height: 30px;margin: 12px }
    .progress_bg{height: 12px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;background-color:#f2f2f2;}
    .progress_bar{background: #5FB878; width: 0; height: 10px; border-radius: 5px;}
    .progress_btn{width: 20px; height: 20px; border-radius: 5px; position: absolute;background:#fff;
left: 0px; margin-left: -10px; top:-5px; cursor: pointer;border:1px #ddd solid;box-sizing:border-box;}
    .progress_btn:hover{border-color:#F7B824;}
    </style>
{% endblock %}
{% block content%}
     <div class="wrapper wrapper-content container   animated fadeInRight" style="overflow: auto;min-width: 500px">
        <div class="row"  >
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>继续工单 </h5>
                      <a  style="float:right" class="btn btn-info btn-add" title="刷新" href="javascript:window.location.reload()"> <span class='glyphicon glyphicon-refresh'/></a>
                    </div>
                    <div class="ibox-content" style="background-color:#F9F9F9 ;overflow: hidden" >
                        <div class=""   style="box-shadow: 0 1px 1px 1px #9F9F9F;background: transparent;">
                            <div class="form-group  " id="top"  style=" font-size:14px;font-weight:bold;text-align: center;padding:10px">
                                {% query_task_map_by_tmid  task_obj.tmid_id  as total_task_obj %}
                                <label class="form-label" for="attribute"  >工单分类:</label>
                                <span id="attribute" >{% change_to_task_type  total_task_obj.type_id  %}</span>
                               <label class="form-label" for="publisher"  >指派人:</label>
                                <span id="publisher"  >{% change_to_staff total_task_obj.assigner_id %}</span>
                               <label class="form-label" for="deadline" >创建时间:</label>
                                   <span id="create_time" >{{ task_obj.create_time |date:"Y-m-d H:i"}}</span>
                               <label class="form-label" for="deadline" >截止时间:</label>
                               {% if task_obj.deadline %}
                                   <span id="deadline" >{{ task_obj.deadline |date:"Y-m-d H:i"}}</span>
                                <label class="form-label" for="countdown"  >倒计时:</label>
                                <span id="countdown"  >{% build_countdown_time task_obj.deadline  %}天</span>
                               {% else %}
                                   <span id="deadline" >{{ total_task_obj.deadline |date:"Y-m-d H:i"}}</span>
                                <label class="form-label" for="countdown"  >倒计时:</label>
                                <span id="countdown"  >{% build_countdown_time total_task_obj.deadline  %}天</span>
                               {% endif %}
                            </div>
                        </div>
                        <div class="container-fluid">
                            <div class="row">
                                    <div class="col-xs-4 col-md-4 col-lg-4" style="position: relative" ><span  style="color:#9F9F9F;font-size: 18px; float: right" class="right" ><span class="glyphicon glyphicon-ok" style="margin-right:-50px;z-index:10;top:0px; background-color: red; "></span><br></span>
                                       <h4 style="color:#1ab394">主工单：</h4>
                                       <label class="form-label" for="task_title"  >工单标题:</label>
                                       <span id="task_title" >{{ total_task_obj.title }}</span>
                                         {% query_task_attachment_by_tid total_task_obj.tid_id as t_attachment_list %}
                                         <div class="form-group  " style="margin-bottom: 0px" id="top" >
                                           <label class="form-label"  >工单描述:</label>
                                            <span  >{{ total_task_obj.content }}</span>
                                        </div>
                                        {% for t_obj in t_attachment_list %}
                                         <div class="form-group  "style="margin-bottom: 0px"   >
                                            <label class="form-label"   >工单附件{{ forloop.counter }}:</label>
                                            <a  href="{% url "attachment_download" %}?url={{ t_obj.attachment }}& name={{ t_obj.name }}">{{ t_obj.name }}</a><br>
                                             <label class="form-label"  >附件描述:</label>
                                            <span  >{{ t_obj.description }}</span>
                                        </div>
                                        {% endfor %}
                                        <div class="form-group  " style="margin-bottom: 0px"  >
                                           <label class="form-label"  >备注:</label>
                                            <span  >{{ total_task_obj.remark }}</span>
                                        </div>
                                        {% if task_obj.title %}
                                            <h4 style="color:#1ab394">个人工单：</h4>
                                            <label class="form-label" for="task_title"  >工单标题:</label>
                                            <span id="task_title" >{{ task_obj.title }}</span>
                                            {% query_task_attachment_by_tasid task_obj.tasid as p_attachment_list %}
                                                 <div class="form-group  " style="margin-bottom: 0px" >
                                                    <label class="form-label" >工单描述:</label>
                                                    <span id="task_title" >{{ task_obj.content }}</span>
                                                </div>
                                                {% for obj in p_attachment_list %}
                                                 <div class="form-group "  >
                                                    <label class="form-label"    >工单附件{{ forloop.counter }}:</label>
                                                    <a  href="{% url "attachment_download" %}?url={{ obj.attachment }}&name={{ obj.name }}">{{ obj.name }}</a><br>
                                                    <label class="form-label" for="task_title"  >附件描述:</label>
                                                    <span id="task_title" >{{ obj.description }}</span>
                                                 </div>
                                             {% endfor %}
                                        {% endif %}
                                    </div>
                                    <div class="col-xs-8 col-md-8 col-lg-8 left" style="border-left:2px solid #9F9F9F;padding: 0 15px 15px 15px;">
                                        <div class="row form-horizontal" style="position: relative;margin:1px;background-color: white">
                                            <h5 style="margin:15px 28px; font-weight:bold;font-size: 15px">添加小结</h5>
                                            <div class="col-xs-12"  >
                                                <div class="form-group" style="margin-top: 25px">
                                                    <label for="title" class="col-xs-4  col-md-2 control-label">标题</label>
                                                      <div class="col-xs-12 col-sm-12 col-md-9 ">
                                                          <input name="title"  class="form-control"  id="title" placeholder="工单名称">
                                                        </input>
                                                      </div>
                                                </div>
                                                <div class="hr-line-dashed"></div>
                                                <div class="form-group" style="padding: 0px">
                                                    <label for="tag" class="control-label col-xs-4  col-md-2">标签</label>
                                                    <div class="col-xs-12 col-sm-12 col-md-9" style="padding: 0px">
                                                        <div class=" col-xs-12 col-md-10">
                                                        <input type="text" name="tag" class="form-control" id="tag" placeholder="请输入要添加的标签">
                                                        </div>
                                                        <div class=" col-xs-12  col-md-2" >
                                                            <button class=" btn  btn-primary inline-block right .add" onclick="AddTag(this)">添加</button>
                                                        </div>
                                                        <div class="col-xs-12" id="tag_container" >
                                                        <div class="tag hidden  " >
                                                            <div class="alert alert-info alert-dismissible pull-left" role="alert" style="margin-bottom: 0px;padding: 2px;margin-right: 25px;">
                                                                <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span></button>
                                                                <strong style="margin-left: 10px;"></strong>
                                                            </div>
                                                        </div>
                                                        </div>
                                                    </div>
                                                    </div>
                                                <div class="hr-line-dashed"></div>
                                                <div class="form-group">
                                                    <label for="summary" class="col-xs-4  col-md-2 control-label">小结</label>
                                                      <div class="col-xs-12 col-sm-12 col-md-9">
                                                          <textarea name="title" style="height:100px;" class="form-control"  id="summary" placeholder="小结"></textarea>
                                                      </div>
                                                </div>
                                                <div class="hr-line-dashed"></div>
                                                <div class="form-group">
                                                    <label  class="col-xs-4  col-md-2 control-label" for="assist">协助</label>
                                                    <div class=" radio col-xs-8 col-md-8" id="assist">
                                                         <label ><input type="radio" name="assist" value="0" checked>否</label>
                                                        <label ><input type="radio" name="assist" value="1" >是</label>
                                                    </div>
                                                </div>
                                                <div class="hr-line-dashed"></div>
                                                <div id="attachment-container" style="position: relative">
                                                  <div class="attachment">
                                        <div  class="form-group  form-inline" style="margin-left:0px ;margin-right: 0px">
                                            <label for="file"  class="control-label col-xs-2">附件</label>
                                              <div class="col-xs-10 col-lg-8 form-inline ">
                                                  <input type="file" name="file"   class="form-control" onchange="UploadFile(this)">
                                                  <button type="button"  class="btn btn-primary inline "  onclick="AddAttachment(this)"><i  style ="" class="glyphicon glyphicon-plus plus "></i></button>
                    {#                              <span  style ="" class="glyphicon glyphicon-plus plus " onclick="AddAttachment(this)" ></span>#}
                                              </div>
                                            </div>
                                        <div class="form-group" style="margin-left:0px ;margin-right: 0px">
                                            <label  for="content" class="control-label col-xs-2">附件描述</label>
                                            <div class="col-xs-8">
                                                <input name="content" class="form-control"  placeholder="附件描述">
                                            </div>
                                        </div>
                                         <div class="hr-line-dashed"></div>
                                    </div>
                                                </div>
                                                <div class="form-group">
                                                <label for="remark" class="col-xs-4  col-md-2 control-label">备注：</label>
                                                  <div class="col-xs-12 col-sm-12 col-md-9">
                                                      <textarea name="remark"  class="form-control"  cols="20" rows="2" id="remark" placeholder="备注"></textarea>
                                                  </div>
                                                </div>
                                                <div class="hr-line-dashed"></div>
                                                <div class="form-group ">
                                                <label for="progress" class="col-xs-4  col-md-2 control-label" >进度评估</label>
                                                <div class="progress col-xs-8"  id="progress">
                                                <div class="progress_bg">
                                                    <div class="progress_bar"></div>
                                                </div>
                                                <div class="progress_btn"></div>
                                                <div class="text">{{ completion }}%</div>
                                            </div>
                                        </div>
                                            </div>
                                            <div class="hr-line-dashed"></div>
                                            <div class="form-group col-xs-12" style="margin-left: 0px">
                                                <div class="hr-line-dashed"></div>
                                                 <div class="row" id="content_footer" >
                                                     <div class="form-actions well well-sm clearfix">
                                                         <button type="submit" onclick="Submit(1)" class="default btn btn-primary hide-xs" name="_save" data-loading-text="保存中.."><i class="fa fa-save"></i> 保存并返回</button>
                                                         <button type="submit"  onclick="Submit(2)" style="background-color: #0ba7a9" class="btn btn-info" data-loading-text="保存并增加另一个.." name="_addanother"><i class="fa fa-save"></i> 保存并继续</button>
                                                         <a href="{% url "personal_task_list" %}"  class="default btn btn-info hide-xs" ><i class="fa fa-reply"></i> 返回</a>
                                                         <!--error_msg-->
                                                         <div class="alert alert-danger hide " onclick="Hidden(this)" style="display:inline-block ;padding: 7px 12px;margin: 0px">
                                                            <span style="padding: 0 5px 0 5px;display: inline-block;font-size: 14px">
                                                                <i class="fa fa-minus-circle" aria-hidden="true"></i>
                                                            </span>
                                                            <span id="error_msg" style="font-size: 14px;"></span>
                                                        </div>
                                                     </div>
                                                 </div>
                                            </div>
                                    </div>
                           </div>
                          </div>
                            {% for item in task_submit_record %}
                                <div class="row">
                                    <div class="col-xs-4 col-md-4 col-lg-4" style="padding:20px;position: relative" ><span  style="color:#9F9F9F;font-size: 18px; float: right;margin-top:8px" class="right" > {{ item.last_edit|date:"Y-m-d " }}<span class="glyphicon glyphicon-ok" style="margin-right:-50px;z-index:10; "></span><br><span class="right" style="font-size: 14px;position:absolute;right: 25px;">{{ item.last_edit|date:"H:i:s "}}</span></span></div>
                                     <div class="col-xs-8 col-md-8 col-lg-8" style="border-left:2px solid #9F9F9F;padding:15px" >
                                     <div class="row form-horizontal" style="margin:1px;background-color: white">
                                     <div style="margin-left:2%">
                                        <label class="form-label" style="margin: 14px  0px 8px  0px ;font-size: 15px;"  >进度评估:</label>
                                         <span  style="font-size: 15px;margin: 18px 15px 15px 15px">{{ item.completion }}%</span><br>
                                         <label class="form-label"  >标题:</label>
                                         <span  >{{ item.title }}</span><br>
                                         <label class="form-label" >标签:</label>
                                         {% build_record_tags_ele  item.tsid%}<br>
                                          <label class="form-label"  >小结:</label>
                                         <span  >{{ item.summary }}</span><br>
                                         {% query_submit_attachment_by_tsid item.tsid as s_attachment_list%}
                                         {% for obj in s_attachment_list %}
                                            <label class="form-label"    >附件{{ forloop.counter }}:</label>
                                            <a  href="{% url "attachment_download" %}?url={{ obj.attachment }}&name={{ obj.name }}">{{ obj.name }}</a><br>
                                            <label class="form-label" for="task_title"  >附件描述:</label>
                                            <span id="task_title" >{{ obj.description }}</span><br>
                                         {% endfor %}
                                          <label class="form-label"  >备注:</label>
                                         <span  >{{ item.remark }}</span><br>
                                     </div>
                                     </div>
                                     </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="container"  style="border-top: 2px double #b1b1b1; width:80%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

              <!-- Modal record_detail -->
<div class="modal fade " id="refer_detail"  tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" onclick="clearReferData()" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title" id="myModalLabel">详细</h3>
      </div>
      <div class="modal-body" style="height: 560px;">
         <div class="row form-horizontal" style="position: relative;">
            <div class="col-xs-12">
                <div class="form-container row clearfix">
                        <div id="column-0" class="formColumn column form-column full col col-sm-12 form-horizontal" span="12" horizontal="">
                            <div class="panel panel-default fieldset unsort no_title" id="box-0" style="border-color: #dddddd">
{#                                <div class="panel-heading"><i class="icon fa fa-chevron-up chevron"></i><h3 class="panel-title"></h3></div>#}
                                <div class="panel-body "style="padding-top:0px;padding-bottom: 0px">
                                    <div class=" form-group row value" >
                                          <div  class="col-xs-3 control-label label_form"  style=" padding: 22px 10px 7px 0px">分类</div>
                                          <div class="col-xs-8 p_form" style=" padding: 15px 10px 7px 0px">
                                             <p class="form-control-static " id="refer_type"></p>
                                          </div>
                                    </div>
                                     <div class=" form-group row value" >
                                          <div  class="col-xs-3 control-label label_form"  style=" padding: 22px 10px 7px 0px">标题</div>
                                          <div class="col-xs-8 p_form" style=" padding: 15px 10px 7px 0px">
                                             <p class="form-control-static " id="refer_title"></p>
                                          </div>
                                    </div>
                                      <div class=" form-group row value" >
                                          <div  class="col-xs-3 control-label label_form"  style=" padding: 22px 10px 7px 0px">标签</div>
                                          <div class="col-xs-8 p_form" style=" padding: 15px 10px 7px 0px">
                                             <p class="form-control-static " id="refer_tag"></p>
                                          </div>
                                    </div>
                                      <div class=" form-group row value" >
                                          <div  class="col-xs-3 control-label label_form"  style=" padding: 22px 10px 7px 0px">小结</div>
                                          <div class="col-xs-8 p_form" style=" padding: 15px 10px 7px 0px">
                                             <p class="form-control-static " id="refer_summary"></p>
                                          </div>
                                    </div>
                                    <div class=" form-group row value" >
                                          <div  class="col-xs-3 control-label label_form"  style=" padding: 22px 10px 7px 0px">备注</div>
                                          <div class="col-xs-8 p_form" style=" padding: 15px 10px 7px 0px">
                                             <p class="form-control-static " id="refer_remark"></p>
                                          </div>
                                    </div>
                                     <div class=" form-group row value" >
                                          <div  class="col-xs-3 control-label label_form"  style=" padding: 22px 10px 7px 0px">收录时间</div>
                                          <div class="col-xs-8 p_form" style=" padding: 15px 10px 7px 0px">
                                             <p class="form-control-static " id="refer_date"></p>
                                          </div>
                                    </div>
                                     <div class=" form-group row value hidden " id="refer_attach" >
                                          <div  class="col-xs-3 control-label label_form"  style=" padding: 22px 10px 7px 0px">附件</div>
                                          <div class="col-xs-8 p_form" id="refer_container" style=" padding: 15px 10px 7px 0px">
                                          </div>
                                    </div>

                                </div>
                                    <div class="actions" >
                                 <input type="text" class="hidden" id="refer_id" name="refer_id" >
                                 <a style="float: right ;font-size: 10px; margin-top: 10px;" onclick="referFavor()" class="btn  btn-white"><i style="color: grey;" id="refer_favor" class="fa fa-thumbs-up"></i> 有用 </a>
                            </div>
                            </div>
                        </div>
                    </div>

              </div>
            </div>
         </div>
      <div class="modal-footer" style="margin-top:20px">
        <button class="btn btn-default" onclick="clearReferData()" data-dismiss="modal" aria-hidden="true">关闭</button>
      </div>
    </div>
    </div>
</div>

{% endblock %}
{% block js %}
    <script>

    //初始化知识库展示框
    window.onload=function () {
        {#$("#right-sidebar",window.parent.document).addClass("sidebar-open");#}
        if ($("#reference",window.parent.document).length == 0){
            $("#theme",window.parent.document).parent().append(
             '<li id="reference" class="active" >\n' +
            '<a data-toggle="tab" href="#tab-2">智引</a>\n' +
            '</li>'
        );
             $("#tab-1",window.parent.document).parent().append(
            ' <div id="tab-2" class="tab-pane ">\n' +
'                <div  class="sidebar-title">\n' +
            '         <h3> <i class="fa fa-cube"></i> AI智引</h3>\n' +
            '         <small><i class="fa fa-tim"></i> 提供具体事情的解决方案...</small>\n' +
            '     </div>\n' +
'                      <ul id="sidebar-list" class="sidebar-list">\n' +
'                      </ul>\n' +
'              </div>')
        }
        //获取相关收录知识
        var tmid="{{ task_obj.tmid_id }}"
        $.ajax({
            url:"{% url 'knowledges' %}",
            type:"get",
            data: {"tmid":tmid} ,
            dataType:"JSON",
            success:function (arg) {
                var data=arg.data
                console.log(data)
                $("#sidebar-list",window.parent.document).empty();
                for(i =0;i<data.length;i++ ){
                    var ele =' <li>\n' +
                             '<div class="small pull-right m-t-xs">{0}</div>\n'.format(data[i].fields.type) +
                        '                    <label>标题:</label><span>{0}</span>\n'.format( data[i].fields.relate_title) +
                        '\n' + ' <br>' +
                        '<label>标签:</label><span>{0}</span>\n'.format( data[i].fields.relate_tag) +
                        '\n' +
                        '                    <div class="small"></div>\n' +
                        '                    <div class="small text-muted m-t-xs">\n<button id="detail{0}"  class="btn detail btn-info btn-xs">查看详细</button></div>\n'.format(data[i].pk,data[i].pk) +
                            '<i  id="favor{0}"  class="fa pull-right fa-thumbs-up">{1}</i>'.format(data[i].pk,data[i].fields.favor)
                        '            </li>'
                    $("#sidebar-list",window.parent.document).append($(ele))
                }
                //绑定详情事件
                 for(i=0;i<data.length;i++ ){
                     let id =data[i].pk
                     $("#detail{0}".format(data[i].pk),window.parent.document)[0].addEventListener("click",function () {
                         showKnowledge(id)
                     })
                 }
            }
        })
         $("#right-sidebar",window.parent.document).addClass("sidebar-open");
         $("#reference",window.parent.document).addClass("active").siblings().removeClass("active");
         $("#tab-2",window.parent.document).addClass("active");
         $("#tab-1",window.parent.document).removeClass("active");
         var timeOut=setTimeout("closeSidebar()", 5000);
         $("#right-sidebar",window.parent.document).hover(
            function () {
                 clearTimeout(timeOut)
         },function () {
                timeOut=setTimeout("closeSidebar()", 5000);
            }
         )
    }

    function closeSidebar() {
          $("#right-sidebar",window.parent.document).removeClass("sidebar-open");
    }
    //进度条
    $(function(){
                var completion={{ completion }}
                var tag = false,ox = 0,left = 200*completion/100, bgleft = 0;
                $('.progress_btn').css('left', left);
                $('.progress_bar').width(left);
                $('.progress_btn').mousedown(function(e) {
                    ox = e.pageX - left;
                    tag = true;
                });
                $(document).mouseup(function() {
                    tag = false;
                });
                $('.progress').mousemove(function(e) {//鼠标移动
                    if (tag) {
                        left = e.pageX - ox;
                        if (left <= 0) {
                            left = 0;
                        }else if (left > 200) {
                            left = 200;
                        }
                        $('.progress_btn').css('left', left);
                        $('.progress_bar').width(left);
                        $('.text').html(parseInt((left/200)*100) + '%');
                    }
                });
                $('.progress_bg').click(function(e) {//鼠标点击
                    if (!tag) {
                        bgleft = $('.progress_bg').offset().left;
                        left = e.pageX - bgleft;
                        if (left <= 0) {
                            left = 0;
                        }else if (left > 200) {
                            left = 200;
                        }
                        $('.progress_btn').css('left', left);
                        $('.progress_bar').animate({width:left},200);
                        $('.text').html(parseInt((left/200)*100) + '%');
                    }
                });
            });

    //添加标签
function AddTag(ths){
        var val=$(ths).parent().parent().find("input").val();
        $(ths).parent().parent().find("input[name=tag]").val("");//清空input 标签
        if (val){
             var tag = $(ths).parent().next().children().first().clone();
             tag.removeClass("hidden");
             $(tag).find("strong").text(val);
             $(ths).parent().next().append(tag);
        }
        else{
            alert("输入不能为空")
        }
    }
//添加附件

var att_num=1
//如果是修改的话，附件计数器设定为已存在的附件数
{% if tid %}
{% for obj in task_attachment_data%}
    att_num+={{ forloop.counter }}
{% endfor %}
{% endif %}
 //获取标签内容
function  FetchTag() {
    var tags=new Array();
    $("#tag").parent().parent().find("strong").each(function () {
        if($(this).text()){
            tag =$(this).text();
            tags.push(tag)
        }
    });
    tags=tags.join("|")
    return tags
}
//修改时获取标签内容
function GetTag() {
    var tags_list = new Array();
    $("#tag").parent().parent().find("strong").each(function (){
        var tag ={"name":'',"tid_id":''};
        var name= $(this).text()
        var ttid=$(this).parent().find("input[name=ttid]").val();
        if (name!=''){
            tag.name=name;
            if(ttid){
                 tag.ttid=ttid
            }
        }else{
            return true;
        }
        tags_list.push(tag)
    })
    tags_list=JSON.stringify(tags_list)
    return tags_list
}

//修改时获取附件
function GetAttachment(){
     var attachment_list=new Array()
     $(".attachment").each(function () {
        var attachment = {"attachment":'',"description":'',"name":'','tid_id':''};
        var tamid= $(this).find("input[name=tamid]").val();
        var file_path= $(this).find("input[name=file_path]").val();
        if (file_path==null){
            //空附件处理
            return true;
        }
        var content=$(this).find("input[name=content]").val();
        var name=$(this).find("input[name=file_name]").val();
        attachment.attachment=file_path;
        attachment.description=content;
        attachment.name=name;
        if (tamid){
            attachment['tamid']=tamid;
        }
        attachment_list.push(attachment)
        });
      attachment_list=JSON.stringify(attachment_list)//对象转化成json
    return attachment_list
}

//创建时获取附件
function FetchAttachment(){
    var attachment_list=new Array()
    $(".attachment").each(function () {
    var attachment = {"attachment":'',"description":'',"name":''};
    var file_path= $(this).find("input[name=file_path]").val();
        //空文件不上传
    if(file_path==null){
        return true;
    }
    var content=$(this).find("input[name=content]").val().trim();
    var name=$(this).find("input[name=file_name]").val();
    attachment.attachment=file_path;
    attachment.description=content;
    attachment.name=name;
    attachment_list.push(attachment)
});
    attachment_list=JSON.stringify(attachment_list)//对象转化成json
    return attachment_list
}
//上传附件
function UploadFile(ths){
    var file_obj = $(ths)[0].files[0];
    var form = new FormData();
    form.append("file", file_obj);
    $.ajax({
        url:"/attachment_upload.html",
        type:"POST",
        data: form ,
        dataType:"JSON",
        // 告诉jQuery不要去处理发送的数据
        processData : false,
        // 告诉jQuery不要去设置Content-Type请求头
        contentType : false,
        success:function (arg) {
            //去掉旧文件
            $(ths).parent().find(".old_file").remove()
            //添加新的file
            var path_input='<input type="text" name="file_path" value=""  class="hidden" >';
            var name_input='<input type="text" name="file_name" value=""  class="hidden" >';
            $(ths).parent().append(path_input);
            $(ths).parent().append(name_input);
            $(ths).parent().find("input[name=file_path]").val(arg.data.path)
            $(ths).parent().find("input[name=file_name]").val(arg.data.name)
        },
    })
}


//工单提交
function Submit(cons) {
        var $msg = $('#error_msg');
        $msg.parent().addClass('hide');
        var title = $("#title").val().trim();
        var summary = $("#summary").val().trim();
        var remark = $("#remark").val().trim();
        var is_assist = $("input[name=assist]:checked").val();
        var completion_str = $(".text").html();
        var completion = parseInt(completion_str);
        var tasid= {{ task_obj.tasid }};
        $.ajax({
                url: "{%url "complete_task" %} ",
                type: "POST",
                data:  {
                    "tasid_id":tasid,
                    "title": title,
                    "summary": summary,
                    "remark":remark,
                    "is_assist":is_assist,
                    "completion":completion,
                    "tags":FetchTag(),
                    "attachment":FetchAttachment(),
        },
            dataType: "json",
            success: function (arg) {
                     if (arg.status) {
                        if (cons==1){
                             window.location.href='{% url "personal_task_list" %}';
                        }else{
                              window.location.href='{% url "complete_task" %}?tasid={0}'.format({{ task_obj.tasid }});
                        }
                    } else {
                        $msg.parent().removeClass('hide');
                        $msg.text(arg.message);
                    }
            }
        })
    }
         //展示参考详细内容
showKnowledge=function (cons) {
      $('#refer_detail').modal('show');
      var id =cons;
      $.ajax({
          url:"{% url "knowledge_detail" %}",
          type:"get",
          data:{'id':id},
          dataType:"json",
          success:function (arg) {
              if (arg.status){
                  var data=arg.data;
                  $("#refer_id").val(data.nid);
                  $("#refer_title").text(data.title);
                  $("#refer_tag").text(data.tag);
                  $("#refer_type").text(data.type_id);
                  $("#refer_favor").text(data.favor);
                  $("#refer_date").text(data.create_time);
                  $("#refer_summary").text(data.summary);
                  $("#refer_remark").text(data.remark);
                  //初始化附件
                  if (data.attach!=""){
                      var attachs = JSON.parse(data.attach);
                      for (var i=0;i<attachs.length;i++){
                      var a_ele=' <label  >附件{0}:</label> <a class="download_file" href="attachment_download.html?url={1}&name={2}">{3}</a><br>'.format(i+1,attachs[i].fields.attachment,attachs[i].fields.name,attachs[i].fields.name)
                      var l_ele=' <label  >附件描述:</label> <span >{0}</span>'.format(attachs[i].fields.description)
                      var eles = a_ele+l_ele+"<br>"
                      $("#refer_container").append(eles)
                      }
                      $("#refer_attach").removeClass("hidden")
                  }
                  // 判断是否点赞
                  if (arg.singal){
                        $("#refer_favor").css('color','lightskyblue')
                  }else{
                       $("#refer_favor").css('color','grey')
                  }
              }
          }
      });
    }

function referFavor() {
    var id=$("#refer_id").val();
    console.log("id",id)
    var uid ={{ request.user.staff.sid }};
    $.ajax({
          url:"{% url "knowledge_favor" %}",
          type:"get",
          data:{'id':id,"user":uid},
          dataType:"json",
          success:function (arg) {
              if (arg.status){
                  var data=arg.data;
                  var signal=data.signal;
                  var count = data.count;
                  $("#favor{0}".format(id),window.parent.document).text(count)
                   $("#refer_favor").text(count)
                  if (signal){
                      $("#refer_favor").css('color','lightskyblue')
                  }else{
                       $("#refer_favor").css('color','grey')
                  }
              }
          }
      });
    }
       //清空参考模态框的数据
function clearReferData(){
            $("#refer_detail >p").each(function () {
                $(this).text()
            })
           $("#refer_container").empty()
          $("#refer_attach").addClass("hidden")
    }

    </script>
{% endblock %}